
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../ROS2_3/">
      
      
        <link rel="next" href="../ROS2_%E3%83%AD%E3%83%9C%E3%82%B3%E3%83%B32/">
      
      
      <link rel="icon" href="../../../../images/sken.jpeg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>ROS2講習ロボコン1 - Sken 技術資料</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.2afb09e1.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+JP:300,300i,400,400i,700,700i%7CInconsolata:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans JP";--md-code-font:"Inconsolata"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ros-2-1-" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Sken 技術資料" class="md-header__button md-logo" aria-label="Sken 技術資料" data-md-component="logo">
      
  <img src="../../../../images/sken.jpeg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Sken 技術資料
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ROS2講習ロボコン1
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Altairu/sken_training_materials" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Altairu/sken_training_materials
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Sken 技術資料" class="md-nav__button md-logo" aria-label="Sken 技術資料" data-md-component="logo">
      
  <img src="../../../../images/sken.jpeg" alt="logo">

    </a>
    Sken 技術資料
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Altairu/sken_training_materials" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Altairu/sken_training_materials
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ホーム画面
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    機械班
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            機械班
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    SolidEdge
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            SolidEdge
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E6%A9%9F%E6%A2%B0%E7%8F%AD/SolidEdge1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SolidEdge環境構築
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    電気班
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            電気班
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" checked>
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ROS 2
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            ROS 2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ROS2_%E4%BA%8B%E5%A7%8B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ROS2環境構築
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ROS2_1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ROS2講習1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ROS2_2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ROS2講習2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ROS2_3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ROS2講習3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    ROS2講習ロボコン1
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    ROS2講習ロボコン1
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      環境
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      初めに
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ros2" class="md-nav__link">
    <span class="md-ellipsis">
      ROS2 を使う理由
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      システム構築
    </span>
  </a>
  
    <nav class="md-nav" aria-label="システム構築">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ros2_1" class="md-nav__link">
    <span class="md-ellipsis">
      ROS2 を用いたシステムの全体構成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      各ノードの役割
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-websocket-web_socket_node" class="md-nav__link">
    <span class="md-ellipsis">
      1. WebSocket 通信ノード (web_socket_node)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-controller_node" class="md-nav__link">
    <span class="md-ellipsis">
      2. コントローラーノード (controller_node)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-serial_send_node" class="md-nav__link">
    <span class="md-ellipsis">
      3. シリアル送信ノード (serial_send_node)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-serial_read_node" class="md-nav__link">
    <span class="md-ellipsis">
      4. シリアル受信ノード (serial_read_node)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-position_node" class="md-nav__link">
    <span class="md-ellipsis">
      5. 自己位置推定ノード (position_node)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      通信層
    </span>
  </a>
  
    <nav class="md-nav" aria-label="通信層">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#websocket" class="md-nav__link">
    <span class="md-ellipsis">
      WebSocket のメリット
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fastapi-websocket" class="md-nav__link">
    <span class="md-ellipsis">
      FastAPI を利用した WebSocket サーバーの実装
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FastAPI を利用した WebSocket サーバーの実装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fastapi" class="md-nav__link">
    <span class="md-ellipsis">
      FastAPI の特徴
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#websocket-fastapi" class="md-nav__link">
    <span class="md-ellipsis">
      WebSocket サーバーの基本実装（FastAPI）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WebSocket サーバーの基本実装（FastAPI）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#web_socket_nodepy" class="md-nav__link">
    <span class="md-ellipsis">
      web_socket_node.py（通信ノード）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#websocket_1" class="md-nav__link">
    <span class="md-ellipsis">
      WebSocket の利用例
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#r1_uitxtui" class="md-nav__link">
    <span class="md-ellipsis">
      R1_UI.txt（UI ファイル）の作成方法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ui" class="md-nav__link">
    <span class="md-ellipsis">
      UI ファイルの基本構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ui_1" class="md-nav__link">
    <span class="md-ellipsis">
      UI ファイルの役割
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      制御層
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      経路計画
    </span>
  </a>
  
    <nav class="md-nav" aria-label="経路計画">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      障害物がない場合
    </span>
  </a>
  
    <nav class="md-nav" aria-label="障害物がない場合">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      計算方法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      計算例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      障害物がある場合
    </span>
  </a>
  
    <nav class="md-nav" aria-label="障害物がある場合">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-aa-star" class="md-nav__link">
    <span class="md-ellipsis">
      ① A*（A-star）アルゴリズム**
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-dynamic-window-approachdwa" class="md-nav__link">
    <span class="md-ellipsis">
      ② Dynamic Window Approach（DWA）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      ③ 事前に決めた座標に向かって移動
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pid" class="md-nav__link">
    <span class="md-ellipsis">
      位置に対するPID制御
    </span>
  </a>
  
    <nav class="md-nav" aria-label="位置に対するPID制御">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pidpython" class="md-nav__link">
    <span class="md-ellipsis">
      位置制御のためのPID制御（Python実装例）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      実装のポイント
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      計算例
    </span>
  </a>
  
    <nav class="md-nav" aria-label="計算例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      初期状態
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      実行後の出力例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      実際のロボコンでは
    </span>
  </a>
  
    <nav class="md-nav" aria-label="実際のロボコンでは">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#controllernode" class="md-nav__link">
    <span class="md-ellipsis">
      ControllerNode の解説
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      ノードの概要
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      初期化処理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      トピックの購読・発行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      目標地点の設定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#websocket_2" class="md-nav__link">
    <span class="md-ellipsis">
      WebSocket からのデータ受信
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      手動・自動モードの切り替え
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      目標地点への移動（経路計画）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      目標地点への移動の計算
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      速度制御
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      角度制御
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      速度指令の送信
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      ハードウェア層
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ハードウェア層">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      ハードウェア層：シリアル通信を用いたマイコンとの連携
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      送受信の通信フォーマット
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      シリアル通信の実装
    </span>
  </a>
  
    <nav class="md-nav" aria-label="シリアル通信の実装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-pc" class="md-nav__link">
    <span class="md-ellipsis">
      (1) PC からマイコンへデータ送信
    </span>
  </a>
  
    <nav class="md-nav" aria-label="(1) PC からマイコンへデータ送信">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python" class="md-nav__link">
    <span class="md-ellipsis">
      Python によるシリアル通信の実装（送信側）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-pc" class="md-nav__link">
    <span class="md-ellipsis">
      (2) マイコンから PC へデータ受信
    </span>
  </a>
  
    <nav class="md-nav" aria-label="(2) マイコンから PC へデータ受信">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python_1" class="md-nav__link">
    <span class="md-ellipsis">
      Python によるシリアル通信の実装（受信側）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ros2_2" class="md-nav__link">
    <span class="md-ellipsis">
      ROS2 ノードとしての実装
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ROS2 ノードとしての実装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      シリアル通信ノードの構成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serial_send_nodepc" class="md-nav__link">
    <span class="md-ellipsis">
      serial_send_node（PC → マイコン）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serial_read_node-pc" class="md-nav__link">
    <span class="md-ellipsis">
      serial_read_node（マイコン → PC）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      センシング層
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#realsense" class="md-nav__link">
    <span class="md-ellipsis">
      RealSenseセンサを用いた自己位置推定
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RealSenseセンサを用いた自己位置推定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#realsense-t265vslam" class="md-nav__link">
    <span class="md-ellipsis">
      RealSense T265（VSLAMを用いた自己位置推定）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RealSense T265（VSLAMを用いた自己位置推定）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      自己位置推定の計算
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ros2_3" class="md-nav__link">
    <span class="md-ellipsis">
      ROS2 ノード実装（自己位置推定）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#realsense-d435i" class="md-nav__link">
    <span class="md-ellipsis">
      RealSense D435i（深度カメラを用いた障害物検出）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RealSense D435i（深度カメラを用いた障害物検出）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ros2_4" class="md-nav__link">
    <span class="md-ellipsis">
      ROS2 ノード実装（深度データ取得）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#yolo" class="md-nav__link">
    <span class="md-ellipsis">
      YOLO を用いた物体認識
    </span>
  </a>
  
    <nav class="md-nav" aria-label="YOLO を用いた物体認識">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ros2_5" class="md-nav__link">
    <span class="md-ellipsis">
      ROS2 ノード実装例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      データ処理手法
    </span>
  </a>
  
    <nav class="md-nav" aria-label="データ処理手法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      ローパスフィルタ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      重み付き平均
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      まとめ
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ROS2_%E3%83%AD%E3%83%9C%E3%82%B3%E3%83%B32/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ROS2講習ロボコン2
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    python3
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            python3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python3/python3_%E4%BA%8B%E5%A7%8B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    python環境構築
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python3/python3%E8%AC%9B%E7%BF%921/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    python_1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python3/python3%E8%AC%9B%E7%BF%922/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    python_2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python3/python3%E8%AC%9B%E7%BF%923/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    python_3
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    回路
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            回路
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%9B%9E%E8%B7%AF/%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kicad環境構築
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%9B%9E%E8%B7%AF/%E5%9B%9E%E8%B7%AF%E8%AC%9B%E7%BF%920/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kicad使い方
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%9B%9E%E8%B7%AF/%E5%9B%9E%E8%B7%AF%E8%AC%9B%E7%BF%921%E3%82%B9%E3%83%A9%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    回路講習1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%9B%9E%E8%B7%AF/%E5%9B%9E%E8%B7%AF%E8%AC%9B%E7%BF%922%E3%82%B9%E3%83%A9%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    回路講習2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%9B%9E%E8%B7%AF/%E5%9B%9E%E8%B7%AF%E8%AC%9B%E7%BF%924/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    回路講習3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%9B%9E%E8%B7%AF/%E5%9B%9E%E8%B7%AF%E8%AC%9B%E7%BF%925/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    回路講習4
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    マイコン
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            マイコン
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_1" >
        
          
          <label class="md-nav__link" for="__nav_3_4_1" id="__nav_3_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    SW4STM32
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_1">
            <span class="md-nav__icon md-icon"></span>
            SW4STM32
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E3%83%9E%E3%82%A4%E3%82%B3%E3%83%B3SW/%E3%83%9E%E3%82%A4%E3%82%B3%E3%83%B31/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SystemWorkbench1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E3%83%9E%E3%82%A4%E3%82%B3%E3%83%B3SW/%E3%83%9E%E3%82%A4%E3%82%B3%E3%83%B32/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SystemWorkbench2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E3%83%9E%E3%82%A4%E3%82%B3%E3%83%B3SW/%E3%83%9E%E3%82%A4%E3%82%B3%E3%83%B33/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SystemWorkbench3
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_2" >
        
          
          <label class="md-nav__link" for="__nav_3_4_2" id="__nav_3_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ESP32
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_2">
            <span class="md-nav__icon md-icon"></span>
            ESP32
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E3%83%9E%E3%82%A4%E3%82%B3%E3%83%B3esp/%E3%83%9E%E3%82%A4%E3%82%B3%E3%83%B31/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ESP32_1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E3%83%9E%E3%82%A4%E3%82%B3%E3%83%B3esp/%E3%83%9E%E3%82%A4%E3%82%B3%E3%83%B32/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ESP32_2
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_3" >
        
          
          <label class="md-nav__link" for="__nav_3_4_3" id="__nav_3_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    CH552
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_3">
            <span class="md-nav__icon md-icon"></span>
            CH552
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CH552/CH552_1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CH552_1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CH552/CH552_2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CH552_2
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../1%E5%B9%B4%E4%BD%93%E9%A8%93%E5%85%A5%E9%83%A8/S-ken%E4%BD%93%E9%A8%93%E5%85%A5%E9%83%A8%E5%88%B6%E5%BE%A1%E7%8F%ADL%E3%81%A1%E3%81%8B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1年体験入部
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pid/pid/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pid
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ubuntu/ubuntu1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ubuntu
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" >
        
          
          <label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    講習課題
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            講習課題
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%89%B9%E8%A8%93%E8%AA%B2%E9%A1%8C/python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    python課題
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../code/python%E7%AD%94%E3%81%88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    python課題答え
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%89%B9%E8%A8%93%E8%AA%B2%E9%A1%8C/%E5%9B%9E%E8%B7%AF/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    回路課題
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    共通資料
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            共通資料
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B1%E6%9C%89/wiki_readme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    wiki使い方
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E3%83%9E%E3%83%BC%E3%82%AF%E3%83%80%E3%82%A6%E3%83%B3%E6%9B%B8%E3%81%8D%E6%96%B9/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    マークダウン書き方
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9/%E3%83%A9%E3%82%A4%E3%82%BB%E3%83%B3%E3%82%B9%E3%82%B9%E3%83%A9%E3%82%A4%E3%83%89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ライセンス
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../github/github1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Github
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../my/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    管理者連絡先
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      環境
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      初めに
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ros2" class="md-nav__link">
    <span class="md-ellipsis">
      ROS2 を使う理由
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      システム構築
    </span>
  </a>
  
    <nav class="md-nav" aria-label="システム構築">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ros2_1" class="md-nav__link">
    <span class="md-ellipsis">
      ROS2 を用いたシステムの全体構成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      各ノードの役割
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-websocket-web_socket_node" class="md-nav__link">
    <span class="md-ellipsis">
      1. WebSocket 通信ノード (web_socket_node)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-controller_node" class="md-nav__link">
    <span class="md-ellipsis">
      2. コントローラーノード (controller_node)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-serial_send_node" class="md-nav__link">
    <span class="md-ellipsis">
      3. シリアル送信ノード (serial_send_node)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-serial_read_node" class="md-nav__link">
    <span class="md-ellipsis">
      4. シリアル受信ノード (serial_read_node)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-position_node" class="md-nav__link">
    <span class="md-ellipsis">
      5. 自己位置推定ノード (position_node)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      通信層
    </span>
  </a>
  
    <nav class="md-nav" aria-label="通信層">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#websocket" class="md-nav__link">
    <span class="md-ellipsis">
      WebSocket のメリット
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fastapi-websocket" class="md-nav__link">
    <span class="md-ellipsis">
      FastAPI を利用した WebSocket サーバーの実装
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FastAPI を利用した WebSocket サーバーの実装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fastapi" class="md-nav__link">
    <span class="md-ellipsis">
      FastAPI の特徴
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#websocket-fastapi" class="md-nav__link">
    <span class="md-ellipsis">
      WebSocket サーバーの基本実装（FastAPI）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WebSocket サーバーの基本実装（FastAPI）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#web_socket_nodepy" class="md-nav__link">
    <span class="md-ellipsis">
      web_socket_node.py（通信ノード）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#websocket_1" class="md-nav__link">
    <span class="md-ellipsis">
      WebSocket の利用例
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#r1_uitxtui" class="md-nav__link">
    <span class="md-ellipsis">
      R1_UI.txt（UI ファイル）の作成方法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ui" class="md-nav__link">
    <span class="md-ellipsis">
      UI ファイルの基本構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ui_1" class="md-nav__link">
    <span class="md-ellipsis">
      UI ファイルの役割
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      制御層
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      経路計画
    </span>
  </a>
  
    <nav class="md-nav" aria-label="経路計画">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      障害物がない場合
    </span>
  </a>
  
    <nav class="md-nav" aria-label="障害物がない場合">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      計算方法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      計算例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      障害物がある場合
    </span>
  </a>
  
    <nav class="md-nav" aria-label="障害物がある場合">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-aa-star" class="md-nav__link">
    <span class="md-ellipsis">
      ① A*（A-star）アルゴリズム**
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-dynamic-window-approachdwa" class="md-nav__link">
    <span class="md-ellipsis">
      ② Dynamic Window Approach（DWA）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      ③ 事前に決めた座標に向かって移動
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pid" class="md-nav__link">
    <span class="md-ellipsis">
      位置に対するPID制御
    </span>
  </a>
  
    <nav class="md-nav" aria-label="位置に対するPID制御">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pidpython" class="md-nav__link">
    <span class="md-ellipsis">
      位置制御のためのPID制御（Python実装例）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      実装のポイント
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      計算例
    </span>
  </a>
  
    <nav class="md-nav" aria-label="計算例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      初期状態
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      実行後の出力例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      実際のロボコンでは
    </span>
  </a>
  
    <nav class="md-nav" aria-label="実際のロボコンでは">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#controllernode" class="md-nav__link">
    <span class="md-ellipsis">
      ControllerNode の解説
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      ノードの概要
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      初期化処理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      トピックの購読・発行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      目標地点の設定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#websocket_2" class="md-nav__link">
    <span class="md-ellipsis">
      WebSocket からのデータ受信
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      手動・自動モードの切り替え
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      目標地点への移動（経路計画）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      目標地点への移動の計算
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      速度制御
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      角度制御
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      速度指令の送信
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      ハードウェア層
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ハードウェア層">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      ハードウェア層：シリアル通信を用いたマイコンとの連携
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      送受信の通信フォーマット
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      シリアル通信の実装
    </span>
  </a>
  
    <nav class="md-nav" aria-label="シリアル通信の実装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-pc" class="md-nav__link">
    <span class="md-ellipsis">
      (1) PC からマイコンへデータ送信
    </span>
  </a>
  
    <nav class="md-nav" aria-label="(1) PC からマイコンへデータ送信">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python" class="md-nav__link">
    <span class="md-ellipsis">
      Python によるシリアル通信の実装（送信側）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-pc" class="md-nav__link">
    <span class="md-ellipsis">
      (2) マイコンから PC へデータ受信
    </span>
  </a>
  
    <nav class="md-nav" aria-label="(2) マイコンから PC へデータ受信">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python_1" class="md-nav__link">
    <span class="md-ellipsis">
      Python によるシリアル通信の実装（受信側）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ros2_2" class="md-nav__link">
    <span class="md-ellipsis">
      ROS2 ノードとしての実装
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ROS2 ノードとしての実装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      シリアル通信ノードの構成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serial_send_nodepc" class="md-nav__link">
    <span class="md-ellipsis">
      serial_send_node（PC → マイコン）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serial_read_node-pc" class="md-nav__link">
    <span class="md-ellipsis">
      serial_read_node（マイコン → PC）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      センシング層
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#realsense" class="md-nav__link">
    <span class="md-ellipsis">
      RealSenseセンサを用いた自己位置推定
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RealSenseセンサを用いた自己位置推定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#realsense-t265vslam" class="md-nav__link">
    <span class="md-ellipsis">
      RealSense T265（VSLAMを用いた自己位置推定）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RealSense T265（VSLAMを用いた自己位置推定）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      自己位置推定の計算
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ros2_3" class="md-nav__link">
    <span class="md-ellipsis">
      ROS2 ノード実装（自己位置推定）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#realsense-d435i" class="md-nav__link">
    <span class="md-ellipsis">
      RealSense D435i（深度カメラを用いた障害物検出）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RealSense D435i（深度カメラを用いた障害物検出）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ros2_4" class="md-nav__link">
    <span class="md-ellipsis">
      ROS2 ノード実装（深度データ取得）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#yolo" class="md-nav__link">
    <span class="md-ellipsis">
      YOLO を用いた物体認識
    </span>
  </a>
  
    <nav class="md-nav" aria-label="YOLO を用いた物体認識">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ros2_5" class="md-nav__link">
    <span class="md-ellipsis">
      ROS2 ノード実装例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      データ処理手法
    </span>
  </a>
  
    <nav class="md-nav" aria-label="データ処理手法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      ローパスフィルタ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      重み付き平均
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      まとめ
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="ros-2-1-">ROS 2 高専ロボコン実践編-その1-</h1>
<h2 id="_1">環境</h2>
<ul>
<li>Python 3.10</li>
<li>ThinkPad L380 Ubuntu 22.04.3 LTS</li>
<li>ROS2 Humble</li>
</ul>
<h2 id="_2">初めに</h2>
<p>まず，高専ロボコンにおける ROS2 の意義について説明する．</p>
<h2 id="ros2">ROS2 を使う理由</h2>
<p>高専ロボコンのロボット開発では，以下の要素が求められる．</p>
<ul>
<li><strong>リアルタイム制御</strong>：センサー情報を処理しながらロボットをスムーズに動作させる．</li>
<li><strong>モジュール化</strong>：複数の機能（モーター制御，画像処理，位置推定など）を分離し，開発しやすくする．</li>
<li><strong>通信の簡素化</strong>：各機能を担当するノード間でのデータのやり取りを簡潔にする．</li>
<li><strong>拡張性</strong>：機能追加がしやすい構造にする．</li>
</ul>
<p>ROS2 は，これらの要素を満たすための優れたフレームワークである．</p>
<p>そこで 2024 年高専ロボコン A チームの Roboware を基に解説をしていく．</p>
<p>https://github.com/SkenHub/2024_A_ROS2_Roboware</p>
<h2 id="_3">システム構築</h2>
<h3 id="ros2_1">ROS2 を用いたシステムの全体構成</h3>
<p>ROS2 を利用したロボコンのシステムでは，以下のような構成を取る．</p>
<ul>
<li><strong>通信層</strong>：WebSocket を用いたスマートフォンとの通信</li>
<li><strong>制御層</strong>：ロボットの運動を計算し，適切な制御コマンドを生成</li>
<li><strong>ハードウェア層</strong>：シリアル通信を介してマイコンへ制御コマンドを送信</li>
<li><strong>センシング層</strong>：カメラや LiDAR を用いた環境認識と自己位置推定など</li>
</ul>
<p>各層の役割を整理すると次のようになる．</p>
<table>
<thead>
<tr>
<th>層</th>
<th>役割</th>
<th>具体的な処理例</th>
</tr>
</thead>
<tbody>
<tr>
<td>通信層</td>
<td>スマホ・PC との通信</td>
<td>WebSocket を使用し，ユーザー入力を取得</td>
</tr>
<tr>
<td>制御層</td>
<td>経路計画・制御</td>
<td>位置推定を行いながら目標地点へ移動</td>
</tr>
<tr>
<td>ハードウェア層</td>
<td>モータードライバの制御</td>
<td>速度・角速度をシリアル通信で送信</td>
</tr>
<tr>
<td>センシング層</td>
<td>ロボットの自己位置推定</td>
<td>RealSense T265 + マイコンのデータ統合</td>
</tr>
</tbody>
</table>
<h3 id="_4">各ノードの役割</h3>
<p>ROS2 の特徴として，機能ごとにノードを分割して管理できる．
以下に例を示す．</p>
<h3 id="1-websocket-web_socket_node">1. WebSocket 通信ノード (<code>web_socket_node</code>)</h3>
<ul>
<li><strong>役割</strong>：スマホコントローラーからの指示を受け取り，ROS2 トピックへ変換</li>
<li><strong>使用技術</strong>：FastAPI，WebSocket，ROS2 パブリッシャー</li>
</ul>
<h3 id="2-controller_node">2. コントローラーノード (<code>controller_node</code>)</h3>
<ul>
<li><strong>役割</strong>：受け取った指示をもとに目標地点を計算し，適切な速度・方向・角速度を算出</li>
<li><strong>重要な処理</strong>：</li>
<li>経路計画（現在位置 → 目標位置）</li>
<li>速度制御（最大速度・加速度制限）</li>
<li>方向制御（回転角度の計算）</li>
</ul>
<h3 id="3-serial_send_node">3. シリアル送信ノード (<code>serial_send_node</code>)</h3>
<ul>
<li><strong>役割</strong>：計算された速度指示をシリアル通信でマイコンへ送信</li>
<li><strong>通信フォーマット</strong>：</li>
<li><code>0xA5 0xA5 [指示番号] [モード] [Vx] [Vy] [omega]</code></li>
<li>115200 bps のシリアル通信で送信</li>
</ul>
<p>以下のCAN通信をおすすめする</p>
<p><a href="https://qiita.com/_Altair_/items/b336bdfb97dfda55da80">USB to CAN モジュールをROS2で</a></p>
<h3 id="4-serial_read_node">4. シリアル受信ノード (<code>serial_read_node</code>)</h3>
<ul>
<li><strong>役割</strong>：マイコンからのフィードバック情報を取得し，自己位置データを ROS2 に公開</li>
<li><strong>通信フォーマット</strong>：</li>
<li><code>0xA5 0xA5 [動作番号] [モード] [X] [Y] [θ]</code></li>
<li>115200 bps のシリアル通信で受信</li>
</ul>
<p>以下のCAN通信をおすすめする</p>
<p><a href="https://qiita.com/_Altair_/items/b336bdfb97dfda55da80">USB to CAN モジュールをROS2で</a></p>
<h3 id="5-position_node">5. 自己位置推定ノード (<code>position_node</code>)</h3>
<ul>
<li><strong>役割</strong>：</li>
<li>マイコンと RealSense T265 からの自己位置データを統合</li>
<li>重み付き平均で誤差補正</li>
<li><code>estimated_position</code> トピックを配信</li>
</ul>
<h2 id="_5">通信層</h2>
<p>高専ロボコンにおいてロボットに対して指令を送る際は遠隔操作を行わなければならない．
そこで通信モジュールとして ESP32，IM920 などが挙げられるが，これらには問題がある．</p>
<ul>
<li><strong>ESP32 の場合</strong></li>
<li>2.4GHz 帯域で通信を行うため，混線の可能性が大きい．</li>
<li>安定した通信を確保するには工夫が必要．</li>
<li><strong>IM920 の場合</strong></li>
<li>電波法の関係上，通信速度に制限がある（長距離通信向けであり、リアルタイム性が求められるロボコンには不向き）．</li>
</ul>
<p>このため，WIFI を用いた通信を選択し，その実装として<strong>WebSocket</strong>を採用する．</p>
<h3 id="websocket">WebSocket のメリット</h3>
<ul>
<li><strong>リアルタイム通信</strong>：ロボットの操作に対し，低遅延で反応できる．</li>
<li><strong>双方向通信</strong>：ロボットの状態をスマートフォンに送信することも可，</li>
<li><strong>軽量</strong>：HTTP リクエストのように毎回ヘッダ情報を送る必要がないため，通信の負荷が軽い．</li>
</ul>
<h2 id="fastapi-websocket">FastAPI を利用した WebSocket サーバーの実装</h2>
<p>WebSocket 通信を ROS2 と連携させるために<strong>FastAPI</strong>を使用する，FastAPI は軽量かつ高性能な Python の Web フレームワークであり，WebSocket を簡単に扱える．</p>
<h3 id="fastapi">FastAPI の特徴</h3>
<ul>
<li><strong>非同期処理（async/await）対応</strong></li>
<li><strong>高速な通信処理（Starlette ベース）</strong></li>
<li><strong>簡単な WebSocket 実装</strong></li>
</ul>
<h3 id="websocket-fastapi">WebSocket サーバーの基本実装（FastAPI）</h3>
<p>以下のコードは，FastAPI を使用して WebSocket サーバーを作成し，クライアントとの通信を管理する．</p>
<h4 id="web_socket_nodepy"><strong><code>web_socket_node.py</code>（通信ノード）</strong></h4>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rclpy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rclpy.node</span><span class="w"> </span><span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">std_msgs.msg</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span><span class="p">,</span> <span class="n">Float32MultiArray</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">WebSocket</span> <span class="k">as</span> <span class="n">FastAPIWebSocket</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTMLResponse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="c1"># IPアドレスとポート設定</span>
<span class="n">IP_ADDRESS</span> <span class="o">=</span> <span class="s1">&#39;192.168.98.216&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8010</span>

<span class="c1"># UIファイル（`R1_UI.txt`）のパス</span>
<span class="n">UI_PATH</span> <span class="o">=</span> <span class="s1">&#39;/home/altair/2024_A_ROS2_Roboware/src/robot_controller/R1_UI.txt&#39;</span>

<span class="c1"># FastAPIのインスタンスを作成</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="c1"># UIの読み込み</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">UI_PATH</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File not found: </span><span class="si">{</span><span class="n">UI_PATH</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">UI_PATH</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="k">class</span><span class="w"> </span><span class="nc">WebSocketNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;web_socket_node&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s1">&#39;web_socket_pub&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span><span class="n">Float32MultiArray</span><span class="p">,</span> <span class="s1">&#39;estimated_position&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">HTMLResponse</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">websocket</span><span class="p">(</span><span class="s1">&#39;/ws&#39;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">websocket_endpoint</span><span class="p">(</span><span class="n">websocket</span><span class="p">:</span> <span class="n">FastAPIWebSocket</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">receive_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">receive_text</span><span class="p">()</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">receive_data</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="n">string_send_data</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_data</span><span class="p">))</span>
                    <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send_text</span><span class="p">(</span><span class="n">string_send_data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WebSocket error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub_msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_data</span> <span class="o">=</span> <span class="n">sub_msg</span><span class="o">.</span><span class="n">data</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_ros2</span><span class="p">():</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">WebSocketNode</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_fastapi</span><span class="p">():</span>
    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">IP_ADDRESS</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">PORT</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">ros2_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_ros2</span><span class="p">)</span>
    <span class="n">ros2_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">fastapi_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_fastapi</span><span class="p">)</span>
    <span class="n">fastapi_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">ros2_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">fastapi_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h3 id="websocket_1">WebSocket の利用例</h3>
<ol>
<li>クライアント（スマートフォン）から<code>ws://&lt;PCのIP&gt;:8000/ws</code>に接続．</li>
<li>JSON 形式のコマンドを送信.</li>
<li>WebSocket ノードが ROS2 のトピックにデータをパブリッシュ.</li>
<li>ROS2 ノードが処理し,ロボットを制御.</li>
<li>ロボットの自己位置データを WebSocket 経由でスマートフォンに送信.</li>
</ol>
<h3 id="r1_uitxtui"><code>R1_UI.txt</code>（UI ファイル）の作成方法</h3>
<p><code>R1_UI.txt</code> は Web ページの UI を記述した HTML ファイルです.このファイルはスマートフォンや PC のブラウザからアクセスし,ボタンやジョイスティックを操作することでロボットを制御するために使用します.</p>
<h3 id="ui"><strong>UI ファイルの基本構造</strong></h3>
<p>UI は HTML + CSS で作成されており,主要な要素は以下の通りです.</p>
<p>例</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Robot Controller<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="w">      </span><span class="nt">body</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="kc">black</span><span class="p">;</span>
<span class="w">        </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="kc">white</span><span class="p">;</span>
<span class="w">        </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="n">Arial</span><span class="p">,</span><span class="w"> </span><span class="kc">sans-serif</span><span class="p">;</span>
<span class="w">        </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="p">.</span><span class="nc">button</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">inline-block</span><span class="p">;</span>
<span class="w">        </span><span class="k">width</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="k">height</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="kc">blue</span><span class="p">;</span>
<span class="w">        </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="kc">white</span><span class="p">;</span>
<span class="w">        </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="kc">none</span><span class="p">;</span>
<span class="w">        </span><span class="k">cursor</span><span class="p">:</span><span class="w"> </span><span class="kc">pointer</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="p">.</span><span class="nc">button</span><span class="p">:</span><span class="nd">hover</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">background-color</span><span class="p">:</span><span class="w"> </span><span class="kc">darkblue</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="p">.</span><span class="nc">joystick-container</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">position</span><span class="p">:</span><span class="w"> </span><span class="kc">absolute</span><span class="p">;</span>
<span class="w">        </span><span class="k">bottom</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="k">left</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="kt">%</span><span class="p">;</span>
<span class="w">        </span><span class="k">transform</span><span class="p">:</span><span class="w"> </span><span class="nb">translateX</span><span class="p">(</span><span class="mi">-50</span><span class="kt">%</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Robot Controller<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;sendCommand(&#39;1&#39;)&quot;</span><span class="p">&gt;</span>Move 1<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;sendCommand(&#39;2&#39;)&quot;</span><span class="p">&gt;</span>Move 2<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;sendCommand(&#39;3&#39;)&quot;</span><span class="p">&gt;</span>Move 3<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;joystick-container&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;range&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;joystickX&quot;</span> <span class="na">min</span><span class="o">=</span><span class="s">&quot;0&quot;</span> <span class="na">max</span><span class="o">=</span><span class="s">&quot;200&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;100&quot;</span> <span class="p">/&gt;</span>
      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;range&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;joystickY&quot;</span> <span class="na">min</span><span class="o">=</span><span class="s">&quot;0&quot;</span> <span class="na">max</span><span class="o">=</span><span class="s">&quot;200&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;100&quot;</span> <span class="p">/&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;sendJoystick()&quot;</span><span class="p">&gt;</span>Send Joystick<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">WebSocket</span><span class="p">(</span><span class="s2">&quot;ws://192.168.98.216:8010/ws&quot;</span><span class="p">);</span>

<span class="w">      </span><span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Received: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="kd">function</span><span class="w"> </span><span class="nx">sendCommand</span><span class="p">(</span><span class="nx">command</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">command</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="kd">function</span><span class="w"> </span><span class="nx">sendJoystick</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">lx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;joystickX&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">ly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;joystickY&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`0,1,0,0,0,0,0,</span><span class="si">${</span><span class="nx">lx</span><span class="si">}</span><span class="sb">,</span><span class="si">${</span><span class="nx">ly</span><span class="si">}</span><span class="sb">,100,100`</span><span class="p">;</span>
<span class="w">        </span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<h3 id="ui_1"><strong>UI ファイルの役割</strong></h3>
<ul>
<li><strong>ボタン制御</strong>：ボタンを押すと,特定の命令（例: <code>Move 1</code>）が WebSocket 経由で送信されます.</li>
<li><strong>ジョイスティック制御</strong>：スライダーで値を変更し,ジョイスティックの X,Y 値を送信することで,ロボットの移動を制御できます.</li>
</ul>
<p>以下に堀君が作製したリポジトリを示す．詳しくは<a href="https://github.com/SkenHub/ros2-websocket-link">こちら</a>を参照せよ．</p>
<h2 id="_6">制御層</h2>
<p>ロボットを自律的に移動させるには，目標地点へ向かうだけでなく，安全かつスムーズに移動するための <strong>経路計画</strong> や <strong>追従制御</strong>，<strong>PID制御</strong> が必要になる．</p>
<p>本資料では，以下のトピックについて詳しく解説する</p>
<ul>
<li><strong>経路計画（現在位置 → 目標位置）</strong></li>
<li><strong>追従制御（経路に対しての追従）</strong></li>
<li>速度制御（最大速度・加速度制限）</li>
<li>方向制御（回転角度の計算）</li>
<li><strong>位置に対するPID制御</strong>
一番実装が容易である．</li>
</ul>
<h2 id="_7"><strong>経路計画</strong></h2>
<h3 id="_8"><strong>障害物がない場合</strong></h3>
<p>最も基本的な経路計画は，「現在位置から目標位置までの直線移動」 である．</p>
<h4 id="_9"><strong>計算方法</strong></h4>
<p>ロボットの現在位置を <span class="arithmatex">\((x_0, y_0)\)</span>，目標位置を <span class="arithmatex">\((x_t, y_t)\)</span> とすると，目標方向 <span class="arithmatex">\(\theta\)</span> は以下の式で計算できる</p>
<div class="arithmatex">\[
\theta = \tan^{-1}\left( \frac{y_t - y_0}{x_t - x_0} \right)
\]</div>
<p>移動距離 <span class="arithmatex">\(d\)</span> は：</p>
<div class="arithmatex">\[
d = \sqrt{(x_t - x_0)^2 + (y_t - y_0)^2}
\]</div>
<p>ロボットの速度 <span class="arithmatex">\(v\)</span> は，最大速度 <span class="arithmatex">\(v_{max}\)</span> を超えないように制限する：</p>
<div class="arithmatex">\[
v = \min(v_{max}, d / t)
\]</div>
<p>ここで <span class="arithmatex">\(t\)</span> は移動にかかる時間である．</p>
<h4 id="_10"><strong>計算例</strong></h4>
<p>現在位置：<span class="arithmatex">\((0, 0)\)</span>，目標位置：<span class="arithmatex">\((1000, 500)\)</span> のとき，</p>
<div class="arithmatex">\[
\theta = \tan^{-1} \left( \frac{500}{1000} \right) = 26.57°
\]</div>
<div class="arithmatex">\[
d = \sqrt{1000^2 + 500^2} = 1118.03 \text{ mm}
\]</div>
<h3 id="_11"><strong>障害物がある場合</strong></h3>
<p>障害物がある場合，直線移動では衝突するため，障害物を避けながら目標地点へ移動する必要がある．そのための経路計画アルゴリズムとして以下がある</p>
<h4 id="1-aa-star"><strong>① A</strong>*（A-star）アルゴリズム**</h4>
<p>A*アルゴリズムは，グリッドマップ上で最短経路を求める代表的な探索アルゴリズムである．</p>
<ul>
<li>
<p><strong>手順</strong></p>
</li>
<li>
<p>スタート地点から目標地点までのグリッドを生成する．</p>
</li>
<li>障害物のあるグリッドを無効にする．</li>
<li>各グリッドに対して，スタート地点からの移動コスト <span class="arithmatex">\(g\)</span> と，ゴールまでの推定コスト <span class="arithmatex">\(h\)</span> を計算し，評価関数 <span class="arithmatex">\(f = g + h\)</span> を算出する．</li>
<li>
<p>最小の <span class="arithmatex">\(f\)</span> を持つグリッドを選択し，ゴールに到達するまで繰り返す．</p>
</li>
<li>
<p><strong>短所</strong>：</p>
</li>
<li>
<p>計算コストが高い</p>
</li>
<li>グリッドの解像度が低いと最適経路にならない</li>
</ul>
<h4 id="2-dynamic-window-approachdwa"><strong>② Dynamic Window Approach（DWA）</strong></h4>
<p>DWAは，ロボットが障害物を回避しながらリアルタイムで動的に経路を生成する手法である．</p>
<ul>
<li>
<p><strong>手順</strong></p>
</li>
<li>
<p>現在のロボットの速度と角速度をもとに，次の動作候補（速度・角速度）を生成する．</p>
</li>
<li>各候補に対して，目標への到達度，障害物との距離，滑らかさを評価し，最適なものを選択する．</li>
<li>
<p>これを繰り返しながら移動する．</p>
</li>
<li>
<p><strong>短所</strong>：</p>
</li>
<li>
<p>事前にコスト関数のチューニングが必要</p>
</li>
<li>近視的な判断をするため，大局的な最適経路にならないことがある</li>
</ul>
<h4 id="3"><strong>③ 事前に決めた座標に向かって移動</strong></h4>
<p>地図が既知の場合，事前に安全な中間座標を決めておき，その座標を順番に移動する方法がある．</p>
<ul>
<li>
<p><strong>手順</strong></p>
</li>
<li>
<p>事前に障害物を回避できる中間地点を定める（例：<span class="arithmatex">\(P_1, P_2, P_3\)</span>）</p>
</li>
<li>現在位置から <span class="arithmatex">\(P_1\)</span> に向かって移動する</li>
<li><span class="arithmatex">\(P_1\)</span> に到達したら，次の目的地 <span class="arithmatex">\(P_2\)</span> に移動する</li>
<li>
<p>最終目的地に到達するまで繰り返す</p>
</li>
<li>
<p><strong>短所</strong>：</p>
</li>
<li>
<p>事前に環境を知っている必要がある</p>
</li>
<li>障害物の変化に対応しづらい</li>
</ul>
<h2 id="pid"><strong>位置に対するPID制御</strong></h2>
<p>PID制御は，目標位置に対する偏差を最小化するために用いられる．</p>
<ul>
<li><strong>比例（P）制御</strong>：位置の偏差に比例した制御入力を出力する</li>
<li><strong>積分（I）制御</strong>：過去の偏差を考慮して誤差を補正する</li>
<li><strong>微分（D）制御</strong>：未来の誤差変化を予測し，急激な変化を抑制する</li>
</ul>
<p>PID制御の式：</p>
<div class="arithmatex">\[
 u(t) = K_p e(t) + K_i \int e(t) dt + K_d \frac{de(t)}{dt}
\]</div>
<p>ここで，<span class="arithmatex">\(e(t)\)</span> は現在の偏差，<span class="arithmatex">\(K_p, K_i, K_d\)</span> はPIDゲインである．</p>
<p>PID制御は，障害物がない移動（直線移動）や，事前に決めた座標への移動に適用される．
以下に、位置制御に対するPID制御の実装例を示す。<br />
このPythonコードでは、現在のロボットの座標<span class="arithmatex">\((X, Y, \Theta)\)</span> と目標座標を入力として、PID制御を適用し、速度<span class="arithmatex">\(V_x, V_y, \omega\)</span> を出力する。</p>
<h3 id="pidpython"><strong>位置制御のためのPID制御（Python実装例）</strong></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PIDController</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Kp</span><span class="p">,</span> <span class="n">Ki</span><span class="p">,</span> <span class="n">Kd</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PID制御の初期化</span>
<span class="sd">        Kp: 比例ゲイン</span>
<span class="sd">        Ki: 積分ゲイン</span>
<span class="sd">        Kd: 微分ゲイン</span>
<span class="sd">        dt: 制御周期（秒）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Kp</span> <span class="o">=</span> <span class="n">Kp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ki</span> <span class="o">=</span> <span class="n">Ki</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Kd</span> <span class="o">=</span> <span class="n">Kd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prev_error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integral</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PID制御計算</span>
<span class="sd">        error: 現在の偏差</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integral</span> <span class="o">+=</span> <span class="n">error</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">derivative</span> <span class="o">=</span> <span class="p">(</span><span class="n">error</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_error</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Kp</span> <span class="o">*</span> <span class="n">error</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ki</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">integral</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Kd</span> <span class="o">*</span> <span class="n">derivative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_error</span> <span class="o">=</span> <span class="n">error</span>
        <span class="k">return</span> <span class="n">output</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PositionPIDController</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Kp_linear</span><span class="p">,</span> <span class="n">Ki_linear</span><span class="p">,</span> <span class="n">Kd_linear</span><span class="p">,</span> <span class="n">Kp_angular</span><span class="p">,</span> <span class="n">Ki_angular</span><span class="p">,</span> <span class="n">Kd_angular</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        位置制御のためのPID制御器</span>
<span class="sd">        Kp_linear, Ki_linear, Kd_linear: 並進方向（X, Y）のPIDゲイン</span>
<span class="sd">        Kp_angular, Ki_angular, Kd_angular: 角速度（ω）のPIDゲイン</span>
<span class="sd">        dt: 制御周期（秒）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid_x</span> <span class="o">=</span> <span class="n">PIDController</span><span class="p">(</span><span class="n">Kp_linear</span><span class="p">,</span> <span class="n">Ki_linear</span><span class="p">,</span> <span class="n">Kd_linear</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid_y</span> <span class="o">=</span> <span class="n">PIDController</span><span class="p">(</span><span class="n">Kp_linear</span><span class="p">,</span> <span class="n">Ki_linear</span><span class="p">,</span> <span class="n">Kd_linear</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid_theta</span> <span class="o">=</span> <span class="n">PIDController</span><span class="p">(</span><span class="n">Kp_angular</span><span class="p">,</span> <span class="n">Ki_angular</span><span class="p">,</span> <span class="n">Kd_angular</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_pos</span><span class="p">,</span> <span class="n">target_pos</span><span class="p">,</span> <span class="n">max_speed</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">max_omega</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        現在位置から目標位置への制御を計算</span>
<span class="sd">        current_pos: [x, y, theta] 現在の座標（mm, mm, deg）</span>
<span class="sd">        target_pos: [x, y, theta] 目標座標（mm, mm, deg）</span>
<span class="sd">        max_speed: 最大速度 [mm/s]</span>
<span class="sd">        max_omega: 最大角速度 [deg/s]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x_error</span> <span class="o">=</span> <span class="n">target_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_error</span> <span class="o">=</span> <span class="n">target_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">theta_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">current_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">360</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>  <span class="c1"># 目標角度との差分</span>
        <span class="k">if</span> <span class="n">theta_error</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
            <span class="n">theta_error</span> <span class="o">-=</span> <span class="mi">360</span>  <span class="c1"># -180 ~ 180 に正規化</span>

        <span class="c1"># PID制御による速度計算</span>
        <span class="n">Vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_x</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">x_error</span><span class="p">)</span>
        <span class="n">Vy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_y</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">y_error</span><span class="p">)</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_theta</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">theta_error</span><span class="p">)</span>

        <span class="c1"># 最大速度制限</span>
        <span class="n">speed</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Vx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Vy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">speed</span> <span class="o">&gt;</span> <span class="n">max_speed</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">max_speed</span> <span class="o">/</span> <span class="n">speed</span>
            <span class="n">Vx</span> <span class="o">*=</span> <span class="n">scale</span>
            <span class="n">Vy</span> <span class="o">*=</span> <span class="n">scale</span>

        <span class="c1"># 最大角速度制限</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="n">max_omega</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_omega</span><span class="p">,</span> <span class="n">omega</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="n">omega</span>

<span class="c1"># テスト用</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># PIDゲイン設定（適宜チューニング）</span>
    <span class="n">Kp_linear</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">Ki_linear</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">Kd_linear</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="n">Kp_angular</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">Ki_angular</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">Kd_angular</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="n">controller</span> <span class="o">=</span> <span class="n">PositionPIDController</span><span class="p">(</span><span class="n">Kp_linear</span><span class="p">,</span> <span class="n">Ki_linear</span><span class="p">,</span> <span class="n">Kd_linear</span><span class="p">,</span> <span class="n">Kp_angular</span><span class="p">,</span> <span class="n">Ki_angular</span><span class="p">,</span> <span class="n">Kd_angular</span><span class="p">)</span>

    <span class="c1"># 現在位置と目標位置</span>
    <span class="n">current_position</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># (X, Y, Theta)</span>
    <span class="n">target_position</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">45</span><span class="p">]</span>  <span class="c1"># (X, Y, Theta)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>  <span class="c1"># 50回更新</span>
        <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="n">omega</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">compute_control</span><span class="p">(</span><span class="n">current_position</span><span class="p">,</span> <span class="n">target_position</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vx: </span><span class="si">{</span><span class="n">Vx</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Vy: </span><span class="si">{</span><span class="n">Vy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Omega: </span><span class="si">{</span><span class="n">omega</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 仮のシミュレーション（現在位置を更新）</span>
        <span class="n">current_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Vx</span> <span class="o">*</span> <span class="mf">0.1</span>  <span class="c1"># 0.1s ごとの移動</span>
        <span class="n">current_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Vy</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="n">current_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">omega</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="n">current_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">%=</span> <span class="mi">360</span>  <span class="c1"># 角度を 0-360 に正規化</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</code></pre></div>
<h3 id="_12"><strong>実装のポイント</strong></h3>
<ul>
<li><strong>PID制御をX, Y, θ（角度）それぞれに適用</strong>  </li>
<li>X, Y は並進方向の制御</li>
<li>
<p>θ はロボットの向きを制御する角速度</p>
</li>
<li>
<p><strong>エラー（目標との差分）に対してPID計算を適用</strong></p>
</li>
<li>直線移動時：<span class="arithmatex">\(V_x, V_y\)</span> を調整して移動</li>
<li>
<p>回転移動時：<span class="arithmatex">\(\omega\)</span> を調整して向きを合わせる</p>
</li>
<li>
<p><strong>速度制限の適用</strong></p>
</li>
<li>平均速度が上限を超えないようにスケーリング</li>
<li>角速度も最大値を設定して制限</li>
</ul>
<h3 id="_13"><strong>計算例</strong></h3>
<h4 id="_14"><strong>初期状態</strong></h4>
<ul>
<li>現在位置：<span class="arithmatex">\((0,0,0)\)</span></li>
<li>目標位置：<span class="arithmatex">\((1000,500,45)\)</span></li>
</ul>
<h4 id="_15"><strong>実行後の出力例</strong></h4>
<p><div class="highlight"><pre><span></span><code><span class="n">Vx</span><span class="p">:</span> <span class="mf">250.00</span><span class="p">,</span> <span class="n">Vy</span><span class="p">:</span> <span class="mf">125.00</span><span class="p">,</span> <span class="n">Omega</span><span class="p">:</span> <span class="mf">10.00</span>
<span class="n">Vx</span><span class="p">:</span> <span class="mf">200.00</span><span class="p">,</span> <span class="n">Vy</span><span class="p">:</span> <span class="mf">100.00</span><span class="p">,</span> <span class="n">Omega</span><span class="p">:</span> <span class="mf">8.00</span>
<span class="n">Vx</span><span class="p">:</span> <span class="mf">150.00</span><span class="p">,</span> <span class="n">Vy</span><span class="p">:</span> <span class="mf">75.00</span><span class="p">,</span> <span class="n">Omega</span><span class="p">:</span> <span class="mf">6.00</span>
<span class="o">...</span>
<span class="n">Vx</span><span class="p">:</span> <span class="mf">0.00</span><span class="p">,</span> <span class="n">Vy</span><span class="p">:</span> <span class="mf">0.00</span><span class="p">,</span> <span class="n">Omega</span><span class="p">:</span> <span class="mf">0.00</span>
</code></pre></div>
このように、ロボットは目標地点に向かって減速しながら移動する.</p>
<h2 id="_16"><strong>実際のロボコンでは</strong></h2>
<p><img alt="picture 0" src="../../../images/c38d6dc2b716936e2cfdfab9a067105c482c9a31eb0cb72f243adf274d23f0c7.png" /><br />
実際に使用したコードの解説を行う．</p>
<h3 id="controllernode"><strong>ControllerNode の解説</strong></h3>
<p><code>ControllerNode</code> は，ロボットの移動制御を担当する ROS2 ノードである．<br />
WebSocket を通じて送信された指令を受け取り，ロボットの移動目標を決定し，適切な速度指令を送信する．  </p>
<h3 id="_17"><strong>ノードの概要</strong></h3>
<table>
<thead>
<tr>
<th>項目</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ノード名</strong></td>
<td><code>controller_node</code></td>
</tr>
<tr>
<td><strong>購読トピック</strong></td>
<td><code>web_socket_pub</code>（WebSocket からの指令），<code>estimated_position</code>（現在位置情報）</td>
</tr>
<tr>
<td><strong>発行トピック</strong></td>
<td><code>cmd_vel</code>（速度指令を送信）</td>
</tr>
<tr>
<td><strong>機能</strong></td>
<td>受信した指令に基づき，ロボットの移動目標を決定し，速度・角速度を計算して送信する</td>
</tr>
</tbody>
</table>
<h3 id="_18"><strong>初期化処理</strong></h3>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ControllerNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;controller_node&#39;</span><span class="p">)</span>
</code></pre></div>
<code>ControllerNode</code> クラスを ROS2 ノードとして初期化する．<br />
ROS2 のノードとして機能するために <code>super().__init__('controller_node')</code> を呼び出す．  </p>
<h3 id="_19"><strong>トピックの購読・発行</strong></h3>
<p><div class="highlight"><pre><span></span><code><span class="bp">self</span><span class="o">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
    <span class="n">String</span><span class="p">,</span>
    <span class="s1">&#39;web_socket_pub&#39;</span><span class="p">,</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">listener_callback</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">Float32MultiArray</span><span class="p">,</span> <span class="s1">&#39;cmd_vel&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">position_subscription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
    <span class="n">Float32MultiArray</span><span class="p">,</span>
    <span class="s1">&#39;estimated_position&#39;</span><span class="p">,</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_position_callback</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">)</span>
</code></pre></div>
- <code>web_socket_pub</code> のデータを購読し，<code>listener_callback</code> 関数を実行する
- <code>cmd_vel</code> トピックを発行し，移動制御の指令を送信する
- <code>estimated_position</code> のデータを購読し，現在位置の更新を行う</p>
<h3 id="_20"><strong>目標地点の設定</strong></h3>
<p><div class="highlight"><pre><span></span><code><span class="bp">self</span><span class="o">.</span><span class="n">locations_normal</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2160</span><span class="p">,</span> <span class="mi">1100</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  
    <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1100</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="s1">&#39;5&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">90</span><span class="p">]</span>
<span class="p">}</span>
<span class="bp">self</span><span class="o">.</span><span class="n">locations_inverted</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1480</span><span class="p">,</span> <span class="mi">1100</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  
    <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1100</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="s1">&#39;5&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">90</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
モード <code>0</code>（通常モード）と <code>1</code>（X軸反転モード）で目標座標を切り替える．<br />
モード <code>1</code> では <code>X</code> 座標が負の値となり，左右対称の座標系となる．  </p>
<h3 id="websocket_2"><strong>WebSocket からのデータ受信</strong></h3>
<p><div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">listener_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;受信データの長さが不足しています: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">個の要素があり，最低でも13個が必要です&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">behavior</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]))</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">emergency_stop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
    <span class="n">lx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
    <span class="n">ly</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
    <span class="n">rx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">ry</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">speedmode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span>
</code></pre></div>
WebSocket から送信されるデータは，カンマ区切りの文字列となっている．<br />
各データを分割し，適切な型に変換して利用する．  </p>
<h3 id="_21"><strong>手動・自動モードの切り替え</strong></h3>
<p><div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">emergency_stop</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">send_velocity_command</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
    <span class="k">return</span>

<span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">behavior</span> <span class="o">==</span> <span class="mi">21</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speedmode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">Vx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx</span><span class="o">-</span><span class="mi">105</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span>
        <span class="n">Vy</span> <span class="o">=</span> <span class="p">(</span><span class="n">ry</span><span class="o">-</span><span class="mi">107</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="p">(</span><span class="n">lx</span><span class="o">-</span><span class="mi">102</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_velocity_command</span><span class="p">(</span><span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">behavior</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_velocity_command</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">behavior</span><span class="p">)</span>
</code></pre></div>
- 非常停止 <code>emergency_stop</code> が <code>1</code> の場合は停止コマンドを送信
- <code>mode == 1</code> の場合，ジョイスティックでの手動操作
  - <code>speedmode == 0</code>（低速モード）と <code>1</code>（高速モード）で速度スケールを変更
  - ジョイスティックの値を <code>Vx, Vy, omega</code> に変換し送信</p>
<h3 id="_22"><strong>目標地点への移動（経路計画）</strong></h3>
<p><div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">button</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">button</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations_normal</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations_inverted</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_to_target</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">mode</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">break</span>
</code></pre></div>
- どのボタンが押されたかをチェックし，対応する目標地点 <code>target</code> を取得
- <code>move_to_target(target, mode, 0)</code> を呼び出し，目標地点に向けて移動を開始</p>
<h3 id="_23"><strong>目標地点への移動の計算</strong></h3>
<p><div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">move_to_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">team_color</span><span class="p">,</span> <span class="n">action_number</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speedmode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_accel</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span> <span class="o">=</span> <span class="mi">800</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_accel</span> <span class="o">=</span> <span class="mi">800</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">target_theta</span> <span class="o">=</span> <span class="n">target</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span> <span class="o">-</span> <span class="mi">90</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
</code></pre></div>
- <code>dx, dy</code> を計算し，目標地点までの距離と方向を算出
- 方向 <code>direction</code> は <code>atan2(dy, dx)</code> を使用して求め，90°ずらしている（正面が 0° になるよう調整）</p>
<h3 id="_24"><strong>速度制御</strong></h3>
<p><div class="highlight"><pre><span></span><code><span class="n">current_speed</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">Vx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span><span class="o">*-</span><span class="mi">1</span>
<span class="n">Vy</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>
</code></pre></div>
- 現在速度 <code>current_speed</code> を計算
- <code>Vx, Vy</code> を計算し，移動方向と速度を決定
- 最大速度 <code>max_speed</code> を超えないよう制限する</p>
<h3 id="_25"><strong>角度制御</strong></h3>
<p><div class="highlight"><pre><span></span><code><span class="n">dtheta</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_theta</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">360</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
<span class="k">if</span> <span class="n">dtheta</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
    <span class="n">dtheta</span> <span class="o">-=</span> <span class="mi">360</span>
<span class="n">omega</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dtheta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_angular_speed</span><span class="p">),</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_angular_speed</span><span class="p">)</span>
</code></pre></div>
- 目標角度 <code>target_theta</code> に向かうための角度偏差 <code>dtheta</code> を計算
- 180°を超えた場合は逆回転を行う
- 角速度 <code>omega</code> は <code>max_angular_speed</code> を超えないよう制限</p>
<h3 id="_26"><strong>速度指令の送信</strong></h3>
<p><div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">send_velocity_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">team_color</span><span class="p">,</span> <span class="n">action_number</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">Float32MultiArray</span><span class="p">()</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">Vx</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">Vy</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">team_color</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">action_number</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div>
- <code>cmd_vel</code> トピックに移動指令を送信</p>
<h2 id="_27">ハードウェア層</h2>
<h3 id="_28"><strong>ハードウェア層：シリアル通信を用いたマイコンとの連携</strong></h3>
<p>ロボットを制御するためには，PC（ROS2）とマイコン（STM32など）が通信し，指令を送受信する必要がある．<br />
高専ロボコンにおいては，リアルタイム性と安定したデータ通信が求められるため，<strong>シリアル通信（UART）</strong> を用いることが一般的である．
シリアル通信とは，データを 1 ビットずつ順番に送受信する通信方式であり，<strong>UART（Universal Asynchronous Receiver Transmitter）</strong> で広く使用される．  </p>
<blockquote>
<p>参考にどうぞ https://github.com/SkenHub/ROS2_Serial/tree/main</p>
</blockquote>
<h3 id="_29"><strong>送受信の通信フォーマット</strong></h3>
<p>本システムでは，PC（ROS2）からマイコンへ指令を送り，マイコンからPCへロボットの状態を報告する．</p>
<table>
<thead>
<tr>
<th>データ方向</th>
<th>フォーマット</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>PC → マイコン</strong></td>
<td><code>[0xA5, 0xA5, 指示番号, モード, Vx, Vy, ω]</code></td>
</tr>
<tr>
<td><strong>マイコン → PC</strong></td>
<td><code>[0xA5, 0xA5, 動作番号, モード, X, Y, θ]</code></td>
</tr>
</tbody>
</table>
<ul>
<li><strong><code>0xA5, 0xA5</code></strong>: ヘッダー（データの開始を示す）</li>
<li><strong><code>指示番号</code></strong>: PC から送信する命令番号（1～20）</li>
<li><strong><code>動作番号</code></strong>: マイコンの現在の動作状態</li>
<li><strong><code>モード</code></strong>: 0（自動制御），1（手動制御）</li>
<li><strong><code>Vx, Vy, ω</code></strong>: ロボットの並進速度・回転速度（単位 mm/s, deg/s）</li>
<li><strong><code>X, Y, θ</code></strong>: マイコンからの自己位置データ（単位 mm, 度）</li>
</ul>
<p>通信フォーマットは固定長（9バイト）にすることで，データ受信の安定性を確保する．</p>
<h2 id="_30"><strong>シリアル通信の実装</strong></h2>
<h3 id="1-pc"><strong>(1) PC からマイコンへデータ送信</strong></h3>
<p>ROS2 の <code>serial_send_node</code> からマイコンへデータを送る．</p>
<h4 id="python"><strong>Python によるシリアル通信の実装（送信側）</strong></h4>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">serial</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>

<span class="c1"># シリアルポート設定</span>
<span class="n">ser</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="s1">&#39;/dev/ttyACM0&#39;</span><span class="p">,</span> <span class="mi">115200</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">HEADER</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xA5\xA5</span><span class="s1">&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">send_data_to_mcu</span><span class="p">(</span><span class="n">command_number</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="n">omega</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;MDD0にデータを送信する関数&quot;&quot;&quot;</span>
    <span class="c1"># 速度の範囲制限（符号付き16ビット整数）</span>
    <span class="n">Vx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">32767</span><span class="p">,</span> <span class="n">Vx</span><span class="p">))</span>
    <span class="n">Vy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">32767</span><span class="p">,</span> <span class="n">Vy</span><span class="p">))</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">32767</span><span class="p">,</span> <span class="n">omega</span><span class="p">))</span>

    <span class="c1"># データをパック</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;BBhhh&#39;</span><span class="p">,</span> <span class="n">command_number</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>
    <span class="n">packet</span> <span class="o">=</span> <span class="n">HEADER</span> <span class="o">+</span> <span class="n">data</span>

    <span class="c1"># 送信</span>
    <span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>

<span class="c1"># 例: 指示番号=1, モード=0, Vx=500, Vy=0, ω=10</span>
<span class="n">send_data_to_mcu</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</code></pre></div>
<h3 id="2-pc"><strong>(2) マイコンから PC へデータ受信</strong></h3>
<h4 id="python_1"><strong>Python によるシリアル通信の実装（受信側）</strong></h4>
<p><div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">receive_data_from_mcu</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;MDD0からデータを受信する関数&quot;&quot;&quot;</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>

    <span class="k">while</span> <span class="n">ser</span><span class="o">.</span><span class="n">in_waiting</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">buffer</span> <span class="o">+=</span> <span class="n">ser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">buffer</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="n">HEADER</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">action_number</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;BBhhh&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received: Action=</span><span class="si">{</span><span class="n">action_number</span><span class="si">}</span><span class="s2">, Mode=</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">, X=</span><span class="si">{</span><span class="n">X</span><span class="si">}</span><span class="s2">, Y=</span><span class="si">{</span><span class="n">Y</span><span class="si">}</span><span class="s2">, Theta=</span><span class="si">{</span><span class="n">theta</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Received data length mismatch&quot;</span><span class="p">)</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>

<span class="n">receive_data_from_mcu</span><span class="p">()</span>
</code></pre></div>
- <strong><code>while ser.in_waiting &gt; 0</code></strong>: 受信バッファにデータがある間，データを読み込む
- <strong><code>if len(buffer) &gt;= 2 and buffer[-2:] == HEADER:</code></strong>: ヘッダーが一致したらデータを受信
- <strong><code>struct.unpack('&gt;BBhhh', data)</code></strong>: バイナリデータを解析し，値を取得</p>
<h2 id="ros2_2"><strong>ROS2 ノードとしての実装</strong></h2>
<h3 id="_31"><strong>シリアル通信ノードの構成</strong></h3>
<table>
<thead>
<tr>
<th>ノード名</th>
<th>機能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>serial_send_node</code></td>
<td>PC → マイコンの指令送信</td>
</tr>
<tr>
<td><code>serial_read_node</code></td>
<td>マイコン → PC のデータ受信</td>
</tr>
</tbody>
</table>
<h3 id="serial_send_nodepc"><strong><code>serial_send_node</code>（PC → マイコン）</strong></h3>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">rclpy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rclpy.node</span><span class="w"> </span><span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">std_msgs.msg</span><span class="w"> </span><span class="kn">import</span> <span class="n">Float32MultiArray</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">serial</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SerialSendNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;serial_send_node&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
            <span class="n">Float32MultiArray</span><span class="p">,</span>
            <span class="s1">&#39;cmd_vel&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listener_callback</span><span class="p">,</span>
            <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="s1">&#39;/dev/ttyACM0&#39;</span><span class="p">,</span> <span class="mi">115200</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">listener_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">command_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">Vx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">Vy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># データ送信</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="n">command_number</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_number</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="n">omega</span><span class="p">):</span>
        <span class="n">HEADER</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xA5\xA5</span><span class="s1">&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;BBhhh&#39;</span><span class="p">,</span> <span class="n">command_number</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">Vx</span><span class="p">,</span> <span class="n">Vy</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">HEADER</span> <span class="o">+</span> <span class="n">data</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">SerialSendNode</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">node</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
- <code>cmd_vel</code> トピックを購読し，マイコンへシリアル通信で送信
- <code>send_data</code> 関数でバイナリデータに変換して送信</p>
<h3 id="serial_read_node-pc"><strong><code>serial_read_node</code>（マイコン → PC）</strong></h3>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SerialReadNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;serial_read_node&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">Float32MultiArray</span><span class="p">,</span> <span class="s1">&#39;robot_position&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="s1">&#39;/dev/ttyACM0&#39;</span><span class="p">,</span> <span class="mi">115200</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_serial_data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_serial_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">in_waiting</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">buffer</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">buffer</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xA5\xA5</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="n">action_number</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;BBhhh&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">Float32MultiArray</span><span class="p">()</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">theta</span><span class="p">)]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">buffer</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">SerialReadNode</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">node</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</code></pre></div>
- <code>robot_position</code> トピックを発行し，受信した座標を送信
- <code>read_serial_data</code> でシリアル通信を監視し，マイコンのデータを取得</p>
<h2 id="_32">センシング層</h2>
<p>ロボットの自律移動には，周囲の環境を認識し，自己位置を正確に推定することが不可欠である．<br />
本章では，<strong>RealSenseセンサ（T265, D435i）を用いた自己位置推定</strong> や <strong>YOLOを用いた物体認識</strong> について解説する．<br />
さらに，<strong>ローパスフィルタ，重み付き平均</strong> を用いたデータ処理手法についても説明する．</p>
<h2 id="realsense"><strong>RealSenseセンサを用いた自己位置推定</strong></h2>
<p>Intel RealSenseは，ステレオカメラやIMUを活用し，<strong>奥行き情報や自己位置の推定</strong> を可能にするセンサである．<br />
たとえば，<strong>T265</strong> を使って自己位置を推定し，<strong>D435i</strong> を使って障害物や人物を検出する．</p>
<h3 id="realsense-t265vslam"><strong>RealSense T265（VSLAMを用いた自己位置推定）</strong></h3>
<p>T265は<strong>Visual SLAM（VSLAM）</strong> を用いて自己位置を推定するカメラである．<br />
IMU（慣性計測装置）と2つの魚眼カメラを組み合わせ，外部のランドマークなしで自己位置を求めることができる．</p>
<h4 id="_33"><strong>自己位置推定の計算</strong></h4>
<p>自己位置は，カメラのIMUデータとVSLAMを統合して得られる．座標系は以下のように定義される：</p>
<ul>
<li><span class="arithmatex">\( x \)</span> 軸：ロボットの右方向（m）</li>
<li><span class="arithmatex">\( y \)</span> 軸：ロボットの前方向（m）</li>
<li><span class="arithmatex">\( \theta \)</span> ：ロボットの回転角度（度）</li>
</ul>
<p>移動距離 <span class="arithmatex">\( d \)</span> は，前回の位置 <span class="arithmatex">\((x_0, y_0)\)</span> と現在位置 <span class="arithmatex">\((x_t, y_t)\)</span> から次のように計算される：</p>
<div class="arithmatex">\[
d = \sqrt{(x_t - x_0)^2 + (y_t - y_0)^2}
\]</div>
<p>ロボットの進行方向 <span class="arithmatex">\(\theta\)</span> は：</p>
<div class="arithmatex">\[
\theta = \tan^{-1} \left( \frac{y_t - y_0}{x_t - x_0} \right)
\]</div>
<h4 id="ros2_3"><strong>ROS2 ノード実装（自己位置推定）</strong></h4>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">rclpy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rclpy.node</span><span class="w"> </span><span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">std_msgs.msg</span><span class="w"> </span><span class="kn">import</span> <span class="n">Float32MultiArray</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyrealsense2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rs</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RealSensePositionNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;realsense_position_node&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">Float32MultiArray</span><span class="p">,</span> <span class="s1">&#39;realsense_position&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">config</span><span class="p">()</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">enable_stream</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">pose</span><span class="p">)</span>  <span class="c1"># IMUとVSLAMによる自己位置推定</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipe</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_position</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipe</span><span class="o">.</span><span class="n">wait_for_frames</span><span class="p">()</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="n">frames</span><span class="o">.</span><span class="n">get_pose_frame</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pose</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">get_pose_data</span><span class="p">()</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">yaw</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">Float32MultiArray</span><span class="p">()</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">theta</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">publisher_</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RealSense Position: X=</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">, Y=</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">, Theta=</span><span class="si">{</span><span class="n">theta</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">destroy_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipe</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">RealSensePositionNode</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">node</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h3 id="realsense-d435i"><strong>RealSense D435i（深度カメラを用いた障害物検出）</strong></h3>
<p>D435iは，<strong>ステレオカメラを用いた深度測定</strong> と <strong>IMUを利用した動き補正</strong> が可能なカメラである．<br />
これを利用して，障害物の有無や人物の検出を行う．</p>
<h4 id="ros2_4"><strong>ROS2 ノード実装（深度データ取得）</strong></h4>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pyrealsense2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="n">pipeline</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">config</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">enable_stream</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="n">rs</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">z16</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">enable_stream</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">color</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="n">rs</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">bgr8</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">wait_for_frames</span><span class="p">()</span>
    <span class="n">depth_frame</span> <span class="o">=</span> <span class="n">frames</span><span class="o">.</span><span class="n">get_depth_frame</span><span class="p">()</span>
    <span class="n">color_frame</span> <span class="o">=</span> <span class="n">frames</span><span class="o">.</span><span class="n">get_color_frame</span><span class="p">()</span>
    <span class="n">depth_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">depth_frame</span><span class="o">.</span><span class="n">get_data</span><span class="p">())</span>
    <span class="n">color_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">color_frame</span><span class="o">.</span><span class="n">get_data</span><span class="p">())</span>

    <span class="c1"># 奥行きデータの取得</span>
    <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">=</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">240</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">depth_frame</span><span class="o">.</span><span class="n">get_distance</span><span class="p">(</span><span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distance to center: </span><span class="si">{</span><span class="n">distance</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">m&quot;</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;Depth Image&quot;</span><span class="p">,</span> <span class="n">depth_image</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;Color Image&quot;</span><span class="p">,</span> <span class="n">color_image</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
        <span class="k">break</span>

<span class="n">pipeline</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
</code></pre></div>
<h2 id="yolo"><strong>YOLO を用いた物体認識</strong></h2>
<p>物体認識には <strong>YOLO（You Only Look Once）</strong> を使用する．<br />
YOLO は高速かつ高精度なリアルタイム物体検出が可能であり，ロボットが人や障害物を認識するために利用する．</p>
<h4 id="ros2_5"><strong>ROS2 ノード実装例</strong></h4>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>

<span class="c1"># YOLOモデルをロード</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/home/altair/Roboware/ultralytics/yolov5&#39;</span><span class="p">,</span> <span class="s1">&#39;custom&#39;</span><span class="p">,</span>
                       <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/home/altair/Roboware/ultralytics/yolov5/yolov5s.pt&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>

<span class="c1"># 画像を読み込み</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s2">&quot;test.jpg&quot;</span><span class="p">)</span>

<span class="c1"># 物体検出を実行</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

<span class="c1"># 結果を表示</span>
<span class="n">results</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<h2 id="_34"><strong>データ処理手法</strong></h2>
<p>センサデータのノイズを減らし，より安定した値を得るために，以下の手法を用いる．</p>
<h3 id="_35"><strong>ローパスフィルタ</strong></h3>
<p>ノイズを除去し，急激な変化を抑えるフィルタ．<br />
フィルタ適用後のデータ <span class="arithmatex">\( X_f \)</span> は以下の式で求められる：</p>
<div class="arithmatex">\[
X_f = \alpha X + (1 - \alpha) X_{prev}
\]</div>
<p>Python 実装：
<div class="highlight"><pre><span></span><code><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">filtered_value</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">new_value</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">previous_value</span>
</code></pre></div></p>
<h3 id="_36"><strong>重み付き平均</strong></h3>
<p>RealSenseとマイコンの自己位置データを統合する方法．<br />
重み <span class="arithmatex">\( w_r, w_m \)</span> を用いて，統合した自己位置 <span class="arithmatex">\( X \)</span> を求める：</p>
<div class="arithmatex">\[
X = \frac{w_r X_r + w_m X_m}{w_r + w_m}
\]</div>
<p>Python 実装：
<div class="highlight"><pre><span></span><code><span class="n">w_r</span> <span class="o">=</span> <span class="mf">0.6</span>
<span class="n">w_m</span> <span class="o">=</span> <span class="mf">0.4</span>
<span class="n">fused_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_r</span> <span class="o">*</span> <span class="n">realsense_x</span> <span class="o">+</span> <span class="n">w_m</span> <span class="o">*</span> <span class="n">microcontroller_x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">w_r</span> <span class="o">+</span> <span class="n">w_m</span><span class="p">)</span>
</code></pre></div></p>
<h2 id="_37">まとめ</h2>
<table>
<thead>
<tr>
<th>層</th>
<th>役割</th>
<th>具体的な処理例</th>
</tr>
</thead>
<tbody>
<tr>
<td>通信層</td>
<td>スマホ・PC との通信</td>
<td>WebSocket を使用し，ユーザー入力を取得</td>
</tr>
<tr>
<td>制御層</td>
<td>経路計画・制御</td>
<td>位置推定を行いながら目標地点へ移動</td>
</tr>
<tr>
<td>ハードウェア層</td>
<td>通信</td>
<td>速度・角速度をシリアル通信で送信</td>
</tr>
<tr>
<td>センシング層</td>
<td>ロボットの自己位置推定</td>
<td>RealSense T265 + マイコンのデータ統合</td>
</tr>
</tbody>
</table>
<p>実際にロボコンで使用された例を基に解説を行った．</p>
<p>次の資料ではこれらを基に簡易的なロボットのRobowareパッケージを構築していく．</p>
<details class="note">
<summary>Note</summary>
<p>著者:Shion Noguchi</p>
</details>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2025 -Altair-
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://x.com/Flying___eagle" target="_blank" rel="noopener" title="mebiusbox2 on Twitter" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M64 32C28.7 32 0 60.7 0 96v320c0 35.3 28.7 64 64 64h320c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64zm297.1 84L257.3 234.6 379.4 396h-95.6L209 298.1 123.3 396H75.8l111-126.9L69.7 116h98l67.7 89.5 78.2-89.5zm-37.8 251.6L153.4 142.9h-28.3l171.8 224.7h26.3z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/Altairu" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            



<h4></h4>
<p></p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
    
      
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="github" checked>
      <span class="task-list-indicator"></span>
      GitHub
    </label>
  </li>

      
    
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
    
    
      <button type="reset" class="md-button md-button--primary">Reject</button>
    
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    
      
      <script id="__config" type="application/json">{"base": "../../../..", "features": [], "search": "../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../../../js/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>